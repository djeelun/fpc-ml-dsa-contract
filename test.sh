#!/usr/bin/env bash

if [[ -z "${FPC_PATH}" ]]; then
  echo "Error: FPC_PATH not set"; exit 1
fi

FABRIC_CFG_PATH="${FPC_PATH}/integration/config"
FABRIC_SCRIPTDIR="${FPC_PATH}/fabric/bin/"

. ${FABRIC_SCRIPTDIR}/lib/common_utils.sh
. ${FABRIC_SCRIPTDIR}/lib/common_ledger.sh

# this is the path points to FPC chaincode binary
CC_PATH=${FPC_PATH}/samples/chaincode/dilithium/_build/lib/

CC_ID=dilithium_test
CC_VER="$(cat ${CC_PATH}/mrenclave)"
CC_EP="OR('SampleOrg.member')"
CC_SEQ="1"

# invalid signature, signature has been purposefully corrupted
SIGNATURE=6542BE6D6CFB9467B2121768ED597A709D122FACEDA2DC610E996049D89BBC877B30DD6A78C2CFF732B4695AE04216345ACB5A8225472110CCCDAC83023C29B339B6AF833BD73083289C663941C3ED17D4629BAAF5B1602FA6234FC3ED3BE5D956E5AF25C2F6AFB1E1D77F6A391753D32E5223E72ED60EB445CB47791620B5A850BC4C7800379EDF7206E5EAC54E80D89BFFD350CBEF20CE494EEBDA63AADF29015A88CEF144FA13EB4D8AA3E68D57F335F5752BAC32063580C8ECA8630EBE4BAFB4572F1784D02C6CBE87C572D42FAE8018F401EF0BF693F9550E8EF0635E90750B4E07283868C042781B2CA30E5904C074034A5512BEABCA93EC4824A0C158E84BB8E5E5502A57F432595E2F1F39ED55D38A67A597698DDDF3E30BDE70E4EAAEA916E8E35341E1085D96A2114DF21037676568F998A4141E27FCDB8EEAB24B2D680D9F277351A63F7459A842861037A5492616BFAD2C7E37DF4FA441C48D701B04CE803738616024C59ADBC0D82DCECA6CE8D0F902731B50C90E62889A5C3DD1A9E4ADBF91CF8A80E91564C80367D14A7F59271DB64B4AF64C1BC14665F1D2DAE3654BA99861AD33B71A05165A2D64DE6FAF314C076956E9C7151DB7FC5FDB90F88949E30B25A916C83B76414C7EA9970CD66953FAB065E61956E5EA95493C119EB8D5425D07C6B1FD65A1857278C3DCCD6CAC200746F6F6D150C0A4B97C667967B93188375CBDF61364B9AE4DCC3BC7E5B34869E6AEDAD8C78B5A2EF3900329508C1985C6C29AC554C27CDFAAE97EBD46ADE4D04F062708BBEF58CEEA1038B4ED259B7B209DC2B56E73C2990530E0ACCD47B91F0791FD05E9BA7466AAFD7747E66D25E16FF73901778FD6BABE0BC419ECD26B588F8F6100D5AAC73DEBDBD82BFD01A3D685B378ED9A50C7D323774E2167D3A1D0815DC63D409F09DFC27045F497BF0B4D957D88B95336AA43C6789137B6998F70C956009AF4CCD4627D18776622A9EFF5AF4458C45EBE65085A1F86805F12F25F9FD329617792C5B5C5B2E57D8042A53BFB4B49027F7D81140444897C0EF4C483A8BF5A5B73AC0516C4DD827556A9B38CD109336B2BCAD8E7EC528134553AF2C9BC8AB59BD58339A348DC67DCE4BC4D164FB7F42921EFEDECF41C780E32A31B4E491A9DA206770DF8A2D72A8C91EA02144EB24758D841618F2E4F2482F45754B7D9FAE86B9E12183367B47F98CEE3FBB8ED390AC827799544D63530A8895933B6BEDE7E97CAC5F6F15BBF08A1FAD1B9EDABB3B53DDF53D630FF672BACB59549856B7D1C99F8A33943AA94270AE2B06A33986FEFFD286FEE019F0084131B84169188E6D4B2B82C42BCFD4A9B95FE53C57C9F69785B8BD6BE6621201FE7D2D146762168D2964E924982A7BF414D9A4044E3C5FF21A7A03B9C9A44826BFB7C4838B4F22BC8496CACCE8131A468BAD0476F81501E551EAE725015E4A2F917A61BE38DEB40580C28F7CBBB511676201118FAE86239522D8AFD9BEF54B334AC074D2946D10EDACF5EF697F1CDD8F24ED4172C19C47026B0583C0B756EA60FBF462864728A720AAD3C099F62B45EE6942498ABC4B81CF08D627E2EB2CF6E25ED994B013082A347FF25FD1636B6540682106A7E988EC225B8AB89885CDBDCFCE3FAEC44E9F2DD36747B5F70E22F74A898809C88F3C911045AC2907D0BEA137F0AB45893380DAD720E357F45575373CF2F05E9DF8436CF0EE6BB331146B78371999D589E3AE8761476B5F5CB9D321F87D945AA0B98CF9410708BD6E937B23220E9318E03EFA86B67C55B20FEE4A852BDA57EFDA24BBF28653D4065D9E181B8880DEF132C064AF5FB5BC51CEBBBEEA69B1AC3912815156CCD1C677CBC1DECD5587E54EC873FF466A630BD77197F0C4D412E58426537F7A5A402B001F907A46BA414B7ACED3D275837FB32C1F0EC69798A0762101C75F96AB7FAD8573EF415416D572B58A12E3219B36F378B8A1B11FD3951689D270DB5EE2F001401DBE5575A15D27F6ACD55C73C4D4361B01A3EC9E0AFE7BFA5307B6037C04E4307B5CD8CA0957392DEF20D1C60764BF2FB0F396A66D615614579C60A412169E2E546F220C6031E067AFB4C4C2C46074DC2C72817DFF647D4FA9AEB62B31642F53BB8A7AE7D44A223734A82DC24401A2B0D89CF501D796B868C665D18DCBDA92CD8B642FD72BFA08F5FDEB4E27A59C22844450909E357FBF8B0AD0AFCF9BF38EC2521B5F1D18B3226AA434587E83FBD057C36E8C01BADDE627926B452F5AA7EB76632CA89A885810C6D02E03AD0ACCED20CE748746DC39CD74A366FBBE16599759520D8BA54C0C1CE329DE5D090EE6D82FF84AEC8089BD859E6FAF80223A305488E7B8713BB95C129D87869A496A82AFCA91968A971ACDDC1147C82D3D6804C1C4DB13526C3B72DCB0FDF8EB4BA350ED16611967226E6F7D3BA8856A7EC3A7C8D454123387D086755A446BF6B12E15D209E2D4159DB1AB024E787021DC223B90119F1A37F4A9EA1188960F2A7438C9D764BB61D7B1093242E5F1D388CAFB7B3BC3E51A63351B5CEF8F74780C4A0C0BC3594E1DEBDDBD2071D98D4EF62C60B9DA77B95C91D3BBABE29952E73D695C714D09C7E4A7AD5D8A428A4B0014EA8D1BA096D905D2BC4472A5B8F4F3F7A2D00690F60CD0912AF1DD8B3D8A74FED21A7E99394BCF3A32F44BA5426F937E94763ADE6EA755EBF611B674467E797B47919B8CDFDC2FED3129F21F1E2DA9A9FEB59F2746FE5A92E05CCFB5D89CFCDE52A68356D038475A4255AEDDA2252094B3C1524F9EE641EA41A582C84D57B078CCF7EBD0B543C76337EF8955201DADDE84E37F7DD46765DB460A2C98E19EEB1ED35550F44BC3F5D02333CF379E1AE32BD264D95086EE14ED058A5B078D0AA5BB476F6C96236E007CE265E75D7D20BCD8E46F17370779F27855DEDD77168F8D1D93C3AFEFF81E2A35D512C094F9D7459AF5792AB7A59C368D68E0B6344CD70D315DA2021A5674D1F8064837D5060996CD991A485066BACD8DBC0111E10033265E5393E085A6A50BEA42823125524925DE4B12D36E4F80ADF4F25E06BC3F488FA322A530564C413D53944CDA963E45E98EB4C30F68B4D8B6956063B39CE199A9B5ED70DA23B47B1B1CE400D84EF61D207A267021CA999B5B2DA9AD1F28C226424A31024C300A52E1CCA9B73A798C9CB9CB74FDEFD48D00ED509658AEF9E3032F3286E057028D6132ECD94C9D9E8CB8F18479012796C5837C1468AAD8661AE5ABFED9A0FC8C9FE8A93AB87C1B5D832ABAC3D18E3EA5812A7485BE9F5010A113B4449555C6DA1B6BFC7C8CDDBE2FC0204072E3B3F4367779BACF6080C28292D415B656D8B9BB0D7DAF3F7102226565A7F828DA2A7AAB7BAD5D7DCF9FC00000000000000000000000000000000121E2E40
MESSAGE=6406930D5D896A768C37B9A67F93F2234598D60EEB77A458B2307C44E1C31DBC41898DD6D6278E3FA145ACC5581BEDE828DE0565A932CE8EEBD05D
CONTEXT=0000000000000000000000000000
PUBKEY=12C58F6E46913EB28188FB061495C22591741AD0E7AE392D6FE0A6BDF9DD427B718CF90FDC85553D01C8D7A4D519CBFEABDDD3241CD6E0B0C1F6391FC141A4A58FD26355FB653BBAE626DF99AD757B484DB05B703EC2C844971C19A8ECD8AFCBCC55DBA9A175560055898533ABCF3DA6CA88C92C80AC8146B4E7239134EFD52CDA6A25AA22F391DFCE03497CEDC7ADC11589A951A916B5548983D4E136717EF3A0FB11F74982054E5E2B561AA286FBF53302D2375340DDD39C9B9DEDA6F63B699EC292AA0D443F3BBB9DC8115E19D66FEE60AAF78E921F6F47BD4D20E10731A4BD16FA3287AC434E64E4375430FBC3DB17231E79AA0B7945B3A145DFE4DC7F726DF19E4B927F0E36C12BE2BDCE0A9C1FC1E4DFC188B06426D482ED6965D449ED4EB97F5B0BDF1A231EBBCF17F6C86E304A8E2B9BC80DDF7D9C9784F6998E9DB46DCEC3D1D43263EB7EFAE21EC6AD57893A62C96F2FCE16010101E54139074456BCD9E3D293974AD75ADC45DDC9A664366D07F737FD0F7F05EE7B8EF14213AF50899E3CF29A0322F1DAFA8128AC1A9503A4810500F492CCD164B22522E973F303BF15D78101DCE9DC6DCEB0134AE315038386B6FEA70438E81EC9759887C2A2FACCB328DD252DFE8D562B190FB39BCFB814E6C7E0D0EE108DD709C67F77E2E515C266C1A157439CC1B24152B8B058D9B0091A0BB820F536339D42C9E43B57146F9F73AED379431D3A318016771078FB58E7237B7117CBEC3C2D0E6C15B83BE4ABF15C24F391C25417F5A01CEC8CACB1C586D494993E2C5AFD7629EA58A5B00A8B6B2A85F4CE668550E43451C66E1DA92F127E8F13B85F6F6E1DBA3CC85BA2692B099634E6A9E52B8B457CE4608D54E846B3F95FB5FC3A62753D5610FB3E987770628027EC57C5E98AC84BB424EAABB23BEF62FC099A6E8E8AF3438F6C3A53E0884E83B6016F9155314BD3290A5AAAA183181E56CDF10E104706330B11EEA12F4711EF84A1375862509AE2481438D54BDE9764552BC5B0C18B556FD5D9C58E395507158ABBD9120FB836CD32BEA3728F309D6EF62379E4FED00127F3EB65502F72D2E7FE57C93664399742CE7CD601C2385C8060600D874CE4DB374FC1BCEB9B8EEB7969FA90AFAA2F162CD60120607B97AE52BB0E5CB9CF58D2B62929A86BFC1E9C80B362A5F6AEE05225F75ACDDED07E91802D8CF6E95F5910AEC5431674409EA9005FCDE36CD871935D634E9DB7C5EAE9FB729BDCBDABC62C3718B5EAE74B9C5C1F138C246677EB379089F0115C98B056D54C23038960393F33331EF27BD0B815F6387AFD99FDBA2EA7E0B13757D6FFF8AF430660221D8A17704CABBFDA599B48751E190F9348F34A559C8B3CDFAB976F22E10DB04E85E965EA4A3873687816630B66784CC6D1FE192D4688466408DAB85F3C7B32A78C40C93ED57A985C53CB66972C5E873E628CAD9C64BD28CC29A3FC6836503E613F41ACE99280EEE8748E3FF670B3CE472F5CF1152EBB8C575A55DD84D6925708FBCF4D51CB86ECB0F97C61311249B874694CC8A44ED20D38F7E11A2A91C0A4AE2B30648C10EE78F9F81663E31549A26DC3D80A40C37FAFECD8C6711C24EF63E8D991A8D1EFB6EB76CB8F5D84804CBDDD2B6BF8F9A08411B31D2595E30F0E61BE545EC9D76DFAE816430F3F46485F7A154780CED5071307150D8424D1B7712AB3047679EAD9D5B2E8F24756BA14DB067936AAD0D6AA033E0FECB0FE48DD8C76A95119B7F77DDA6D0734B6855ABFD4D575C9DB78F9F35E8452A4E84E91DB9756A741F36827FA0EC4041C36B202DA389A17D6D0129D08DF1EA97A666C3EA0693735EC369B4D4A0D1C9B543E

run_test() {
    # install *mldsa* chaincode
    # input:  CC_ID:chaincode name; CC_VER:chaincode version;
    #         CC_PATH:path to build artifacts
    say "- install dilithium chaincode"
    PKG=/tmp/${CC_ID}.tar.gz
    ${PEER_CMD} lifecycle chaincode package --lang fpc-c --label ${CC_ID} --path ${CC_PATH} ${PKG}
    ${PEER_CMD} lifecycle chaincode install ${PKG}

    PKG_ID=$(${PEER_CMD} lifecycle chaincode queryinstalled | awk "/Package ID: ${CC_ID}/{print}" | sed -n 's/^Package ID: //; s/, Label:.*$//;p')

    ${PEER_CMD} lifecycle chaincode approveformyorg -o ${ORDERER_ADDR} -C ${CHAN_ID} --package-id ${PKG_ID} --name ${CC_ID} --version ${CC_VER} --sequence ${CC_SEQ} --signature-policy ${CC_EP}
    ${PEER_CMD} lifecycle chaincode checkcommitreadiness -C ${CHAN_ID} --name ${CC_ID} --version ${CC_VER} --sequence ${CC_SEQ} --signature-policy ${CC_EP}
    ${PEER_CMD} lifecycle chaincode commit -o ${ORDERER_ADDR} -C ${CHAN_ID} --name ${CC_ID} --version ${CC_VER} --sequence ${CC_SEQ} --signature-policy ${CC_EP}

    # create an FPC chaincode enclave
    ${PEER_CMD} lifecycle chaincode initEnclave -o ${ORDERER_ADDR} --peerAddresses "localhost:7051" --name ${CC_ID}
    
    # verify signature of proof
    # run test with go app
    say "- interact with the FPC chaincode using our client app"
    export CC_ID
    export CHAN_ID
    go run client_app/dilithium.go
}

trap ledger_shutdown EXIT

say "Setup ledger ..."
ledger_init

para
say "Run mldsa test ..."
run_test

para
say "Shutdown ledger ..."
ledger_shutdown

yell "DILITHIUM test PASSED"

exit 0
